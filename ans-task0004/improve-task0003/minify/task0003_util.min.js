function initLocalStorage(){var e=document.getElementById("cate-list");if(e.innerHTML='<li class="default icon-floder current-cate" id="default">默认分类&nbsp;(0)</li>',localStorage.getItem("***分类")&&localStorage.getItem("***名单")){var t=localStorage.getItem("***分类");t=t.split(","),removeClass(document.getElementById("all-task"),"current-cate");for(var a=1;a<t.length;a++)getCate(null,t[a],!0)}else localStorage.setItem("***分类","默认分类"),localStorage.setItem("***名单","***名单,***分类,默认分类");getNumTasks(),sortByDate(),showTask(-1),cancelTask()}function getCate(e,t,a){var n=document.createElement("li");n.innerHTML=t+'&nbsp;(0)<span class="icon-delete"></span>',e?(n.className=a?"icon-paper":"icon-paper current-cate",n.style.paddingLeft=parseInt(e.style.paddingLeft||0)+20+"px",n.style.backgroundPosition=parseInt(e.style.backgroundPosition||"10px 6px")+20+"px 6px",removeClass(e,"current-cate"),e.parentElement.insertBefore(n,e.nextSibling)):(n.className=a?"icon-floder":"icon-floder current-cate",e=document.getElementById("default"),removeClass(document.getElementById("all-task"),"current-cate"),e.parentElement.insertBefore(n,e));var l=localStorage.getItem(t);if(l){l=l.split(",");for(var r=0;r<l.length;r++)getCate(n,l[r],a)}}function setCate(e,t){var a;if(e){var n=e.innerHTML,l=n.substring(0,n.indexOf("&nbsp;"));a=localStorage.getItem(l),a?localStorage.setItem(l,a+","+t):localStorage.setItem(l,t)}else a=localStorage.getItem("***分类"),localStorage.setItem("***分类",a+","+t);addName(t)}function getTaskList(e){var t=e.target||e.srcElement;focusCurrentCate(t),getTask(t),sortByDate(),showTask(-1),cancelTask()}function focusCurrentCate(e){var t=document.getElementById("all-task");removeClass(t,"current-cate");for(var a=document.getElementById("cate-list").getElementsByTagName("li"),n=0;n<a.length;n++)removeClass(a[n],"current-cate");addClass(e,"current-cate")}function adaptiveHeight(e){var t=document.documentElement.clientHeight,a=document.getElementById("header").offsetHeight,n=document.getElementById("add-cate").offsetHeight,l=t-a-n-1>e?t-a-n-1:e,r=document.getElementById("category");r.style.height=l+"px";var s=document.getElementById("task");s.style.height=l+"px";var i=document.getElementById("inner-content");i.style.height=l+"px";var o=document.getElementById("inner-content").clientHeight,d=document.getElementById("task-title").offsetHeight,c=document.getElementById("task-date").offsetHeight,m=o-d-c-n-30,u=document.getElementById("textarea");u.style.height=m+"px"}function getCurrentCate(){for(var e=document.getElementById("cate-list").getElementsByTagName("li"),t=null,a=0;a<e.length&&(t=e[a],!hasClass(t,"current-cate"));a++);return a===e.length&&(t=null),t}function getCurrentCateName(){var e=getCurrentCate()||document.getElementById("default"),t=e.innerHTML,a=t.substring(0,t.indexOf("&nbsp;"));return a}function preAddCate(){var e=getCurrentCate();if(e&&hasClass(e,"default"))return void alert("不能为默认分类添加子分类");if(e){var t=e.innerHTML,a=t.substring(0,t.indexOf("&nbsp;"));if(localStorage.getItem("@"+a))return void alert("不能为已有直接任务的分类添加子分类")}cancelTask(),overlay("addCate");var n=document.getElementById("mask-input");addEvent(n,"keyup",function(t){var a=n.value;13===t.keyCode&&(""===a?alert("分类名不能为空"):a.indexOf(",")!==-1?alert("命名不能包含逗号"):a.indexOf("@")!==-1?alert("命名不能包含@符"):isDuplicateKey(a)?alert("不能重复命名分类名称和任务标题"):execAddCate(e,a))})}function isDuplicateKey(e){var t=!1,a=localStorage.getItem("***名单");a=a.split(",");for(var n=0;n<a.length;n++)if(a[n]===e){t=!0;break}return t}function execAddCate(e,t){setCate(e,t),clearOverlay("addCate"),getCate(e,t,!1);for(var a,n=document.getElementById("cate-list").getElementsByTagName("li"),l=0;l<n.length&&(a=n[l],!hasClass(a,"current-cate"));l++);getTask(a),sortByDate(),showTask(-1)}function addName(e){var t=localStorage.getItem("***名单");localStorage.setItem("***名单",t+","+e)}function overlay(e,t){var a=document.createElement("div");if(a.id="mask",a.className="mask",document.body.appendChild(a),addEvent(a,"click",function(){clearOverlay(e)}),"addCate"===e){var n=document.createElement("input");n.id="mask-input",n.className="mask-input",n.setAttribute("type","text"),document.body.appendChild(n),n=document.getElementById("mask-input"),n.focus()}if("delCate"===e){var l=document.createElement("div");l.innerHTML='<p>确认删除该分类？</p><input class="confirm-ok" type="button" value="确认"><input class="confirm-cancel" type="button" value="取消">',l.id="confirmDelCate",l.className="confirm",document.body.appendChild(l),delegateEvent(l,"input","click",function(e){var a=e.target||e.srcElement,n=a.getAttribute("value");execDelCate(n,t)});var r=document.documentElement.clientWidth,s=document.documentElement.clientHeight;l=document.getElementById("confirmDelCate"),l.style.left=(r-l.offsetWidth)/2+"px",l.style.top=(s-l.offsetHeight)/2+"px"}if("confirmDone"===e){var i=document.createElement("div");i.innerHTML='<p>确认完成该任务？</p><input class="confirm-ok" type="button" value="确认"><input class="confirm-cancel" type="button" value="取消">',i.id="confirmDone",i.className="confirm",document.body.appendChild(i),delegateEvent(i,"input","click",function(e){var t=e.target||e.srcElement,a=t.getAttribute("value");clearOverlay("confirmDone"),"确认"===a&&markDone()}),r=document.documentElement.clientWidth,s=document.documentElement.clientHeight,i=document.getElementById("confirmDone"),i.style.left=(r-i.offsetWidth)/2+"px",i.style.top=(s-i.offsetHeight)/2+"px"}}function clearOverlay(e){if("addCate"===e){var t=document.getElementById("mask-input");document.body.removeChild(t)}if("delCate"===e){var a=document.getElementById("confirmDelCate");document.body.removeChild(a)}if("confirmDone"===e){var n=document.getElementById("confirmDone");document.body.removeChild(n)}var l=document.getElementById("mask");document.body.removeChild(l)}function iconDelete(e){var t=e.target||e.srcElement,a=t.tagName.toLowerCase(),n=e.type,l=null;"li"===a?l=t.getElementsByTagName("span")[0]:"span"===a&&(l=t),l&&("mouseover"===n&&(l.style.visibility="visible"),"mouseout"===n&&(l.style.visibility="hidden"))}function execDelCate(e,t){if(clearOverlay("delCate"),"确认"===e){var a=t.innerHTML,n=a.substring(0,a.indexOf("&nbsp;"));removeCate(n),removeCateName(t),initLocalStorage()}}function removeCate(e){var t=localStorage.getItem(e),a=localStorage.getItem("@"+e);if(t){t=t.split(",");for(var n=0;n<t.length;n++)removeCate(t[n]);localStorage.removeItem(e)}else if(a){a=JSON.parse(a).tasks;for(var l=0;l<a.length;l++)rmValueStr("***名单",a[l].title);localStorage.removeItem("@"+e)}rmValueStr("***名单",e)}function removeCateName(e){var t,a=e.innerHTML,n=a.substring(0,a.indexOf("&nbsp;")),l=parseInt(e.style.paddingLeft||0);if(0===l)t="***分类";else{var r,s,i=e;do i=i.previousElementSibling,r=parseInt(i.style.paddingLeft||0);while(r!==l-20);s=i.innerHTML,t=s.substring(0,s.indexOf("&nbsp;"))}rmValueStr(t,n)}function rmValueStr(e,t){var a=localStorage.getItem(e);a&&(a=a.split(","),a.splice(a.indexOf(t),1),a.length>0?localStorage.setItem(e,a.join(",")):localStorage.removeItem(e))}function markDone(){for(var e=document.getElementById("taskname").value,t=0;t<arrTasks.length;t++)if(arrTasks[t].title===e){var a=arrTasks[t].directCate;break}var n=JSON.parse(localStorage.getItem(a));for(t=0;t<n.tasks.length;t++)if(n.tasks[t].title===e){n.tasks[t].done=1;break}localStorage.setItem(a,JSON.stringify(n)),readonlyStyle(1),getNumTasks();var l=getCurrentCate()||document.getElementById("all-task");getTask(l),sortByDate(),showTask(-1,e)}function editTask(e){isNewTask=e;var t=document.getElementById("btns");t.style.display="inline-block";var a=document.getElementById("cursor");a.style.cursor="pointer";var n=document.getElementById("taskname"),l=document.getElementById("set-date");l.previousElementSibling.style.visibility="visible";var r=document.getElementById("textarea");e&&(n.value="",l.value="",r.value=""),n.removeAttribute("readonly"),l.removeAttribute("readonly"),r.removeAttribute("readonly");var s=document.getElementById("tip-title"),i=document.getElementById("tip-date"),o=document.getElementById("tip-content");s.style.display="inline-block",i.style.display="inline-block",o.style.display="inline-block";var d=document.getElementById("icon-finish"),c=document.getElementById("icon-edit");d.style.visibility="hidden",c.style.visibility="hidden",n.focus()}function addTaskContentEvents(){var e=20,t=500,a=document.getElementById("taskname"),n=document.getElementById("tip-title");addEvent(a,"keyup",function(){validLength(a,e,n)});var l=document.getElementById("set-date"),r=document.getElementById("tip-date");addEvent(l,"keyup",function(){validDateFmt(l,r)});var s=document.getElementById("textarea"),i=document.getElementById("tip-content");addEvent(s,"keyup",function(){validLength(s,t,i)});var o=document.getElementById("btn-cancel");addEvent(o,"click",function(){if(isNewTask)cancelTask();else{for(var e=document.getElementById("task-list").getElementsByTagName("li"),t=0;t<e.length;t++)if(hasClass(e[t],"current-task")){var n=e[t].innerHTML;break}for(var r=0;r<arrTasks.length;r++)if(arrTasks[r].title===n){a.value=arrTasks[r].title,l.value=arrTasks[r].date,s.value=arrTasks[r].content;break}readonlyStyle(0)}});var d=document.getElementById("btn-confirm");addEvent(d,"click",function(){validLength(a,e,n),validDateFmt(l,r),validLength(s,t,i);var o=n.style.color,d=r.style.color,c=i.style.color;"rgb(255, 0, 0)"===o||"rgb(255, 0, 0)"===d||"rgb(255, 0, 0)"===c||(isNewTask&&isDuplicateKey(a.value)?alert("不能重复命名分类名称和任务标题"):confirmTask(a.value,l.value,s.value))});var c=document.getElementById("icon-finish");addEvent(c,"click",function(){overlay("confirmDone")});var m=document.getElementById("icon-edit");addEvent(m,"click",function(){editTask(!1)})}function validLength(e,t,a){var n=e.value.split("").length,l=!(0===n||n>t),r=a.innerHTML,s=r.substring(0,r.indexOf("&nbsp;")),i=r.split("/");i[0]=n,a.innerHTML=s+"&nbsp;"+i.join("/"),l?a.style.color="#999":a.style.color="#f00"}function validDateFmt(e,t){var a=new RegExp("^(([0-9]{3}[1-9]|[0-9]{2}[1-9][0-9]{1}|[0-9]{1}[1-9][0-9]{2}|[1-9][0-9]{3})-(((0[13578]|1[02])-(0[1-9]|[12][0-9]|3[01]))|((0[469]|11)-(0[1-9]|[12][0-9]|30))|(02-(0[1-9]|[1][0-9]|2[0-8]))))$|^((([0-9]{2})(0[48]|[2468][048]|[13579][26])|((0[48]|[2468][048]|[3579][26])00))-02-29)$"),n=a.test(e.value);n?t.style.color="#999":t.style.color="#f00"}function cancelTask(){var e=document.getElementById("btns");e.style.display="none";var t=document.getElementById("cursor");t.style.cursor="auto";var a=document.getElementById("taskname"),n=document.getElementById("set-date");n.previousElementSibling.style.visibility="hidden";var l=document.getElementById("textarea");a.value="",n.value="",l.value="",a.setAttribute("readonly","readonly"),n.setAttribute("readonly","readonly"),l.setAttribute("readonly","readonly");var r=document.getElementById("tip-title"),s=document.getElementById("tip-date"),i=document.getElementById("tip-content");r.style.display="none",s.style.display="none",i.style.display="none";var o=document.getElementById("icon-finish"),d=document.getElementById("icon-edit");o.style.visibility="hidden",d.style.visibility="hidden"}function confirmTask(e,t,a){var n={title:e,date:t,content:a,done:0};if(isNewTask){var l=getCurrentCateName();n.directCate="@"+l;var r=localStorage.getItem(n.directCate);r||(localStorage.setItem(n.directCate,'{"tasks":[]}'),r=localStorage.getItem(n.directCate)),r=JSON.parse(r),r.tasks.push(n)}else{for(var s=document.getElementById("task-list").getElementsByTagName("li"),i=0;i<s.length;i++)if(hasClass(s[i],"current-task")){var o=s[i].textContent;break}for(i=0;i<arrTasks.length;i++)if(arrTasks[i].title===o){n.directCate=arrTasks[i].directCate;break}for(r=JSON.parse(localStorage.getItem(n.directCate)),i=0;i<r.tasks.length;i++)if(r.tasks[i].title===o){r.tasks[i]=n;break}rmValueStr("***名单",o)}localStorage.setItem(n.directCate,JSON.stringify(r)),addName(n.title),readonlyStyle(n.done),getNumTasks();var d=getCurrentCate()||document.getElementById("all-task");getTask(d),sortByDate(),showTask(-1,n.title)}function readonlyStyle(e){var t=document.getElementById("btns");t.style.display="none";var a=document.getElementById("cursor");a.style.cursor="auto";var n=document.getElementById("taskname"),l=document.getElementById("set-date");l.previousElementSibling.style.visibility="visible";var r=document.getElementById("textarea");n.setAttribute("readonly","readonly"),l.setAttribute("readonly","readonly"),r.setAttribute("readonly","readonly");var s=document.getElementById("tip-title"),i=document.getElementById("tip-date"),o=document.getElementById("tip-content");s.style.display="none",i.style.display="none",o.style.display="none";var d=document.getElementById("icon-finish"),c=document.getElementById("icon-edit");e?(d.style.visibility="hidden",c.style.visibility="hidden"):(d.style.visibility="visible",c.style.visibility="visible")}function getTask(e){var t=e.innerHTML,a=t.substring(0,t.indexOf("&nbsp;"));"所有任务"===a&&(a="***分类"),arrTasks=[],getSubTask(a)}function getSubTask(e){if(localStorage.getItem("@"+e))for(var t=JSON.parse(localStorage.getItem("@"+e)).tasks,a=0;a<t.length;a++)arrTasks.push(t[a]);else if(localStorage.getItem(e))for(var n=localStorage.getItem(e).split(","),l=0;l<n.length;l++)getSubTask(n[l])}function getNumTasks(){var e=document.getElementById("all-task");getTask(e),e.innerHTML=e.innerHTML.replace(/\(\d+\)/,"("+arrTasks.length+")");for(var t=document.getElementById("cate-list").getElementsByTagName("li"),a=0;a<t.length;a++)getTask(t[a]),t[a].innerHTML=t[a].innerHTML.replace(/\(\d+\)/,"("+arrTasks.length+")")}function sortByDate(){for(var e,t=1;t<arrTasks.length;t++)for(var a=0;a<t;a++)if(arrTasks[t].date<arrTasks[a].date){e=arrTasks[t];for(var n=t;n>a;n--)arrTasks[n]=arrTasks[n-1];arrTasks[a]=e}}function showTask(e,t){var a=document.getElementById("task-list");a.innerHTML="";for(var n=document.createElement("p"),l=document.createElement("ul"),r=document.createElement("li"),s="xxxx-xx-xx",i=0;i<arrTasks.length;i++)e!==-1&&e!==arrTasks[i].done||(arrTasks[i].date!==s&&(""!==l.innerHTML&&(a.appendChild(l),l=document.createElement("ul")),n.textContent=arrTasks[i].date,a.appendChild(n),n=document.createElement("p"),s=arrTasks[i].date),r.textContent=arrTasks[i].title,arrTasks[i].done&&addClass(r,"done"),t&&t===arrTasks[i].title&&addClass(r,"current-task"),l.appendChild(r),r=document.createElement("li"));""!==l.innerHTML&&a.appendChild(l)}function execFilter(e){for(var t=document.getElementById("filter").getElementsByTagName("span"),a=0;a<t.length;a++)removeClass(t[a],"current-filter");var n=e.target||e.srcElement;switch(addClass(n,"current-filter"),n.innerHTML){case"所有":showTask(-1);break;case"未完成":showTask(0);break;case"已完成":showTask(1)}cancelTask()}function checkoutTask(e){for(var t=document.getElementById("task-list").getElementsByTagName("li"),a=0;a<t.length;a++)removeClass(t[a],"current-task");var n=e.target||e.srcElement;addClass(n,"current-task");for(var l=n.innerHTML,r=0;r<arrTasks.length;r++){var s=arrTasks[r];if(s.title===l)break}var i=document.getElementById("taskname"),o=document.getElementById("set-date"),d=document.getElementById("textarea");i.value=s.title,o.value=s.date,d.value=s.content,readonlyStyle(s.done)}function addEvent(e,t,a){e.addEventListener?e.addEventListener(t,a):e.attachEvent?e.attachEvent("on"+t,a):e["on"+t]=a}function delegateEvent(e,t,a,n){addEvent(e,a,function(e){var a=e.target||e.srcElement;a.tagName.toLowerCase()==t&&n(e)})}function hasClass(e,t){var a=!1,n=e.className;return n.indexOf(t)!==-1&&(a=!0),a}function addClass(e,t){var a=e.className;hasClass(e,t)||(""===a?e.className=t:e.className=a+" "+t)}function removeClass(e,t){var a=e.className,n=new RegExp(" "+t+"|"+t+" |"+t);e.className=a.replace(n,"")}window.onload=function(){var e=document.getElementById("category").clientHeight,t=document.getElementById("add-cate").offsetHeight,a=e-t;adaptiveHeight(a),window.onresize=function(){adaptiveHeight(a)},initLocalStorage();var n=document.getElementById("all-task");addEvent(n,"click",getTaskList);var l=document.getElementById("cate-list");delegateEvent(l,"li","click",getTaskList);var r=document.getElementById("add-cate");addEvent(r,"click",preAddCate),delegateEvent(l,"li","mouseover",iconDelete),delegateEvent(l,"li","mouseout",iconDelete),delegateEvent(l,"span","mouseover",iconDelete),delegateEvent(l,"span","mouseout",iconDelete),delegateEvent(l,"span","click",function(e){var t=(e.target||e.srcElement).parentElement;overlay("delCate",t)});var s=document.getElementById("filter");delegateEvent(s,"span","click",execFilter);var i=document.getElementById("task-list");delegateEvent(i,"li","click",checkoutTask);var o=document.getElementById("add-task");addEvent(o,"click",function(){var e=getCurrentCateName();localStorage.getItem(e)?alert("不能为已有子分类的分类添加任务"):editTask(!0)}),addTaskContentEvents()};var arrTasks=[],isNewTask=!0;